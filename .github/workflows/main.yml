name: Safe Daily Dependency Update

on:
  schedule:
    - cron: '0 22 * * *'
  workflow_dispatch:

jobs:
  update-dependencies:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js with cache
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies cleanly
        run: npm ci

      - name: Check for outdated packages
        run: npm outdated || true

      - name: Safe update dependencies
        id: update
        run: |
          set -e
          echo "Running npm update..."
          npm update || {
            echo "âš ï¸ npm update failed. Trying with --legacy-peer-deps"
            npm update --legacy-peer-deps || {
              echo "âŒ npm update completely failed. Exiting."
              echo "changed=false" >> "$GITHUB_OUTPUT"
              exit 0
            }
          }

          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add package*.json package-lock.json || true

          if git diff --cached --quiet; then
            echo "No dependency changes."
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "Dependencies updated."
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Verify build and tests
        if: steps.update.outputs.changed == 'true'
        run: |
          npm run build
          npm test -- --watchAll=false

      - name: Create Pull Request
        if: steps.update.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: "chore: safe daily dependency update"
          branch: dependency-update
          title: "chore: Safe Daily Dependency Update"
          body: |
            ğŸ“¦ Updated dependencies using `npm update`  
            âœ… Verified with `build` and `test`  
            ğŸ›¡ï¸ Used `--legacy-peer-deps` fallback only if necessary  
            ğŸ” Run daily at 10PM UTC
          labels: |
            dependencies
            automated
